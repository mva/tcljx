(ns tcljx.alpha.ptest__align-test
  (:require [tcljx.alpha.textflow :as tf]
            [tcljx.alpha.ptest__style :as style]
            [tcljx.alpha.ptest__pp :as pp]
            [tcljx.alpha.ptest__align :refer :all]
            [tcljx.alpha.ptest :refer :all])
  (:import (tcljx.alpha.ptest__align Arr)))

(defn diff-stringv ^vector [form-a form-b]
  (let [style (style/env-style 80 false)
        forms (aligned-form form-a form-b
                            (.compact-diff? style) (.alternates-style style))
        multi-frag (-> (tf/mk-cursor)
                       (pp/pretty1 forms (.page-width style))
                       (tf/fragment))
        str-view #(-> (tf/mk-cursor)
                      (pp/isolate-view-into multi-frag ^int %)
                      (tf/fragment)
                      (tf/str-render))]
    (vector (str-view 0) (str-view 1))))

(deftest alignment-form-test
  (is (= ["[:a :b   ]"
          "[   :b :a]"]
         (diff-stringv [:a :b] [:b :a]))))

;;; ------------------------------------------------------------------------

;; (print-ea-lines "EYEBALL TEST print-ea-lines (compact, red-blue)"
;;                 [:a] [:bb]
;;                 (style/env-style 80 true))
;; (print-ea-lines "EYEBALL TEST print-ea-lines (interleaved, plain-text)"
;;                 [:aa] [:b]
;;                 (style/env-style 80 false))

;; (print-ea-columns "EYEBALL TEST print-ea-columns (compact, red-blue)"
;;                   [:a [:c :d]] [:b [:c :d]]
;;                   (style/env-style 26 true))
;; (print-ea-columns "EYEBALL TEST print-ea-columns (interleaved, plain-text)"
;;                   [:a [:c :d]] [:b [:c :d]]
;;                   (style/env-style 26 false))

#_
(deftest equiv-fail-manual-check        ;assumes page-width of 38+4+38
  (is (= [:a] [:b]))
  (is (= [:a] [:bb]))
  (is (= [:aa] [:b]))
  (is (= [:a :b] [:b :a]))

  ;; note: vector and seq are equivalent, but are rendered as a full
  ;; replacement in case of mismatch
  (is (= ["" "a" "aa" "aaa" "aaaa"] (take 5 (iterate #(str % "a") ""))))
  
  (is (= ()
         (->> (iterate #(str % "a") "") (take 10) (drop 2))))
  (is (= ()
         (->> (iterate #(str % "a") "") (take 10) (drop 1))))
  
  (is (= (->> (iterate #(str % "e") "") (take 6) (drop 0))
         (->> (iterate #(str % "a") "") (take 6) (drop 0))))
  (is (= (->> (iterate #(str % "e") "") (take 7) (drop 2))
         (->> (iterate #(str % "a") "") (take 7) (drop 2)))))

#_
(deftest equiv-fail-manual-color-bleed  ;assumes page-width of 38+4+38
  ;; for the opening "[", the left hand side's color should not bleed
  ;; over to the right side, and vice versa for the closing "]"
  (is (= [(->> (iterate #(str % "e") "") (take 7) (seq))]
         [(->> (iterate #(str % "a") "") (take 7) (vec))])))
