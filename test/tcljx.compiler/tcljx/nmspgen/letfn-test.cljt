;; Copyright (c) Michael van Acken. All rights reserved.
;; The use and distribution terms for this software are covered by the
;; Eclipse Public License 2.0 (https://www.eclipse.org/legal/epl-v20.html)
;; which can be found in the file epl-v20.html at the root of this distribution.
;; By using this software in any fashion, you are agreeing to be bound by
;; the terms of this license.
;; You must not remove this notice, or any other, from this software.
(ns tcljx.nmspgen.letfn-test
  (:require [tcljx.nmspgen.bootstrap :refer [nmsp]]
            [tcljx.alpha.ptest :refer :all]))

(deftest empty-bindings
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "two" "()I")
             (ICONST_2)
             (IRETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def two (letfn* []
                                  2))]))))

(deftest def-fn
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "two" "I")]
            
            [(METHOD [PUBLIC STATIC FINAL] "some-name~2" "(II)I")
             ["LOCAL 0: int a"]
             ["LOCAL 1: int b"]
             (ILOAD_0)
             (ILOAD_1)
             (IADD)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "add2" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "some-name~2" "(II)I"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_1)
             (ICONST_1)
             (INVOKESTATIC . "some-name~2" "(II)I")
             (PUTSTATIC . "two" "I")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(some-name ^int [^int a ^int b]
                                     (+ a b))]
                         (def add2 some-name))
                 (def two (add2 1 1))]))))

(deftest def-fn-delegate
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "oddfalse" "Z")]
            [(FIELD [PUBLIC STATIC FINAL] "oddtrue" "Z")]
            
            [(METHOD [STATIC FINAL] "incomplete-even~1" "(I)Z")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IFNE L:0)
             (ICONST_1)
             (IRETURN)
             [L:0]
             (ICONST_0)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "rec-odd~1" "(I)Z")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IFNE L:0)
             (ICONST_0)
             (IRETURN)
             [L:0]
             (ILOAD_0)
             (ICONST_1)
             (ISUB)
             (INVOKESTATIC . "incomplete-even~1" "(I)Z")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "is-odd" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "rec-odd~1" "(I)Z"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_0)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (PUTSTATIC . "oddfalse" "Z")
                         
             (ICONST_1)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (PUTSTATIC . "oddtrue" "Z")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(incomplete-even ^boolean [^int n]
                                           (= n 0))
                          (rec-odd ^boolean [^int n]
                                   (if (= n 0)
                                     false
                                     (incomplete-even (- n 1))))]
                         (def is-odd rec-odd))
                 (def oddfalse (is-odd 0))
                 (def oddtrue (is-odd 1))]))))

(deftest def-fn-delegate-forward
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "oddfalse" "Z")]
            [(FIELD [PUBLIC STATIC FINAL] "oddtrue" "Z")]
            
            [(METHOD [PUBLIC STATIC FINAL] "rec-odd~1" "(I)Z")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IFNE L:0)
             (ICONST_0)
             (IRETURN)
             [L:0]
             (ILOAD_0)
             (ICONST_1)
             (ISUB)
             (INVOKESTATIC . "incomplete-even~1" "(I)Z")
             (IRETURN)]
            [(METHOD [STATIC FINAL] "incomplete-even~1" "(I)Z")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IFNE L:0)
             (ICONST_1)
             (IRETURN)
             [L:0]
             (ICONST_0)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "is-odd" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "rec-odd~1" "(I)Z"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_0)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (PUTSTATIC . "oddfalse" "Z")
             
             (ICONST_1)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (PUTSTATIC . "oddtrue" "Z")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(rec-odd ^boolean [^int n]
                                   (if (= n 0)
                                     false
                                     (incomplete-even (- n 1))))
                          (incomplete-even ^boolean [^int n]
                                           (= n 0))]
                         (def is-odd rec-odd))
                 (def oddfalse (is-odd 0))
                 (def oddtrue (is-odd 1))]))))

(deftest def-fn-recursive-statics
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "oddfalse" "Z")]
            [(FIELD [PUBLIC STATIC FINAL] "oddtrue" "Z")]
            
            [(METHOD [STATIC FINAL] "rec-even~1" "(I)Z")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IFNE L:0)
             (ICONST_1)
             (IRETURN)
             [L:0]
             (ILOAD_0)
             (ICONST_1)
             (ISUB)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "rec-odd~1" "(I)Z")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IFNE L:0)
             (ICONST_0)
             (IRETURN)
             [L:0]
             (ILOAD_0)
             (ICONST_1)
             (ISUB)
             (INVOKESTATIC . "rec-even~1" "(I)Z")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "is-odd" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "rec-odd~1" "(I)Z"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_2)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (PUTSTATIC . "oddfalse" "Z")
             
             (ICONST_3)
             (INVOKESTATIC . "rec-odd~1" "(I)Z")
             (PUTSTATIC . "oddtrue" "Z")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(rec-even ^boolean [^int n]
                                    (if (= n 0) true (rec-odd (- n 1))))
                          (rec-odd ^boolean [^int n]
                                   (if (= n 0) false (rec-even (- n 1))))]
                         (def is-odd rec-odd))
                 (def oddfalse (is-odd 2)) ;does invokestatic of rec-odd
                 (def oddtrue (is-odd 3))])))) ;does invokestatic of rec-odd

(deftest def-fn-recursive-flyweights
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "oddfalse" "Z")]
            [(FIELD [PUBLIC STATIC FINAL] "oddtrue" "Z")]
            
            [(METHOD [STATIC FINAL] "is-odd$rec-even~1" "(II)Z")
             ["LOCAL 0: int cutoff"]
             ["LOCAL 1: int n"]
             (ILOAD_1)
             (ILOAD_0)
             (ISUB)
             (IFNE L:0)
             (ICONST_1)
             (IRETURN)
             [L:0]
             (ILOAD_0)
             (ILOAD_1)
             (ICONST_1)
             (ISUB)
             (INVOKESTATIC . "is-odd$rec-odd~1" "(II)Z")
             (IRETURN)]
            [(METHOD [STATIC FINAL] "is-odd$rec-odd~1" "(II)Z")
             ["LOCAL 0: int cutoff"]
             ["LOCAL 1: int n"]
             (ILOAD_1)
             (ILOAD_0)
             (ISUB)
             (IFNE L:0)
             (ICONST_0)
             (IRETURN)
             [L:0]
             (ILOAD_0)
             (ILOAD_1)
             (ICONST_1)
             (ISUB)
             (INVOKESTATIC . "is-odd$rec-even~1" "(II)Z")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "is-odd~2" "(II)Z")
             ["LOCAL 0: int cutoff"]
             ["LOCAL 1: int x"]
             (ILOAD_0)
             (ILOAD_1)
             (INVOKESTATIC . "is-odd$rec-odd~1" "(II)Z")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "is-odd" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "is-odd~2" "(II)Z"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (BIPUSH -2)
             (ICONST_2)
             (INVOKESTATIC . "is-odd~2" "(II)Z")
             (PUTSTATIC . "oddfalse" "Z")
             
             (BIPUSH -2)
             (ICONST_3)
             (INVOKESTATIC . "is-odd~2" "(II)Z")
             (PUTSTATIC . "oddtrue" "Z")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def is-odd (fn* is-odd ^boolean [^int cutoff ^int x]
                                  (letfn* [(rec-even ^boolean [^int n]
                                                     (if (= (- n cutoff) 0) true (rec-odd (- n 1))))
                                           (rec-odd ^boolean [^int n]
                                                    (if (= (- n cutoff) 0) false (rec-even (- n 1))))]
                                          (rec-odd x))))
                 (def oddfalse (is-odd -2 2))
                 (def oddtrue (is-odd -2 3))]))))

(deftest self-ref-statics
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "self-ref~0" "()Ljava/lang/Object;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "self-ref~0" "()Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (INVOKESTATIC . "self-ref~0" "()Ljava/lang/Object;")
             (POP)
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(self-ref ^Object []
                                    self-ref)]
                         (self-ref))]))))

(deftest self-ref-virtuals-stateful
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "f~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object n"]
             (ALOAD_0)
             (INVOKESTATIC f$self-ref "__create" "(Ljava/lang/Object;)Lpkg/ns0/f$self-ref;")
             (ASTORE_1)
             ["LOCAL 1: f$self-ref self-ref"]
             (ALOAD_1)
             (INVOKEVIRTUAL f$self-ref "fn0" "()Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/f$self-ref" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "n" "Ljava/lang/Object;")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()Ljava/lang/Object;")
             ["LOCAL 0: f$self-ref self-ref"]
             (ALOAD_0)
             (GETFIELD . "n" "Ljava/lang/Object;")
             (LDC "")
             (INVOKESTATIC Objects "toString" "(Ljava/lang/Object;Ljava/lang/String;)Ljava/lang/String;")
             (POP)
             (ALOAD_0)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: f$self-ref __this"]
             #_["LOCAL 1: int n"]
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: f$self-ref __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/Object;)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: Object n"]
             (ALOAD_0)
             (ALOAD_2)
             (PUTFIELD . "n" "Ljava/lang/Object;")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(Ljava/lang/Object;)Lpkg/ns0/f$self-ref;")
             #_["LOCAL 0: Object n"]
             (NEW f$self-ref) (DUP)
             (ACONST_NULL)
             (ALOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/Object;)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/f$self-ref;")
             #_["LOCAL 0: f$self-ref __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW f$self-ref) (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "n" "Ljava/lang/Object;")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/Object;)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f [n]
                             (letfn* [(self-ref ^Object []
                                                (str n)
                                                self-ref)]
                                     (self-ref))))]))))

(deftest other-ref-statics
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "other-ref~0" "()Ljava/lang/Object;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "some-fn~0" "()Ljava/lang/Object;"]]])
             (ARETURN)]
                        
            [(METHOD [PUBLIC STATIC FINAL] "some-fn~0" "()Ljava/lang/Object;")
             (ACONST_NULL)
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (INVOKESTATIC . "other-ref~0" "()Ljava/lang/Object;")
             (POP)
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(other-ref []
                                     some-fn)
                          (some-fn []
                                   nil)]
                         (other-ref))]))))

(deftest flyweight
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "f$flyweight~0" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (ICONST_0)
             (IALOAD)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f~1" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (INVOKESTATIC . "f$flyweight~0" "([I)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~1" "([I)I"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f ^int [^int/1 a]
                             (letfn* [(flyweight ^int []
                                                 (aget a 0))]
                                     (flyweight))))]))))

(deftest flyweight-stateless
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "f$flyweight~1" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (ICONST_0)
             (IALOAD)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f~1" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (INVOKESTATIC . "f$flyweight~1" "([I)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~1" "([I)I"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f ^int [^int/1 a]
                             (letfn* [(flyweight ^int [^int/1 a]
                                                 (aget a 0))]
                                     (flyweight a))))]))))

(deftest flyweight-indirect
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "f$fw1~0" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (ICONST_0)
             (IALOAD)
             (IRETURN)]
            [(METHOD [STATIC FINAL] "f$fw2~0" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (INVOKESTATIC . "f$fw1~0" "([I)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f~1" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (INVOKESTATIC . "f$fw2~0" "([I)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~1" "([I)I"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f ^int [^int/1 a]
                             (letfn* [(fw1 ^int []
                                           (aget a 0))
                                      (fw2 ^int []
                                           (fw1))]
                                     (fw2))))]))))

(deftest flyweight-forward
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "f$fw2~0" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (INVOKESTATIC . "f$fw1~0" "([I)I")
             (IRETURN)]
            [(METHOD [STATIC FINAL] "f$fw1~0" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (ICONST_0)
             (IALOAD)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f~1" "([I)I")
             ["LOCAL 0: int[] a"]
             (ALOAD_0)
             (INVOKESTATIC . "f$fw2~0" "([I)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~1" "([I)I"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f ^int [^int/1 a]
                             (letfn* [(fw2 ^int []
                                           (fw1))
                                      (fw1 ^int []
                                           (aget a 0))]
                                     (fw2))))]))))

(deftest flyweight-invoke-recursive
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "step~0" "()Ljava/lang/Object;")
             (INVOKESTATIC . "step~0" "()Ljava/lang/Object;")
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1"
                     "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (let* [x (fn* step []
                               (step))])]))))

(deftest flyweight-name-conflict
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "f$fw1-fn~0" "(I)I")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (IRETURN)]
            [(METHOD [STATIC FINAL] "f$fw2-fn~0" "(II)I")
             ["LOCAL 0: int n"]
             ["LOCAL 1: int n"]
             (ILOAD_1)
             (ILOAD_0)
             (INVOKESTATIC . "f$fw1-fn~0" "(I)I")
             (IMUL)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f~2" "(II)Ljava/lang/Object;")
             ["LOCAL 0: int a"]
             ["LOCAL 1: int b"]
             (ILOAD_0)
             (ILOAD_1)
             (IADD)
             (ISTORE_2)
             ["LOCAL 2: int n"]
             (ILOAD_0)
             (ILOAD_1)
             (ISUB)
             (ISTORE_3)
             ["LOCAL 3: int n"]
             ;; order of loads is arbitrary, but it must match the
             ;; usage (via __create, the instance's zero arity method,
             ;; and to f$fw2-fn~0 below) and should be deterministic
             ;; across compiler runs
             (ILOAD_2)
             (ILOAD_3)
             (INVOKESTATIC f$g "__create" "(II)Lpkg/ns0/f$g;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~2" "(II)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/f$g" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "n" "I")]
            [(FIELD [PRIVATE FINAL] "n^1" "I")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()I")
             ["LOCAL 0: f$g g"]
             (ALOAD_0)
             (GETFIELD . "n" "I")
             (ALOAD_0)
             (GETFIELD . "n^1" "I")
             (INVOKESTATIC _10 "f$fw2-fn~0" "(II)I")
             (IRETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: f$g __this"]
             #_["LOCAL 1: int n"]
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()I"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: f$g __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()I"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;II)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: int n"]
             #_["LOCAL 3: int n^1"]
             (ALOAD_0)
             (ILOAD_2)
             (PUTFIELD . "n" "I")
             (ALOAD_0)
             (ILOAD_3)
             (PUTFIELD . "n^1" "I")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(II)Lpkg/ns0/f$g;")
             #_["LOCAL 0: int n"]
             #_["LOCAL 1: int n^1"]
             (NEW f$g) (DUP)
             (ACONST_NULL)
             (ILOAD_0)
             (ILOAD_1)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;II)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/f$g;")
             #_["LOCAL 0: f$g __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW f$g) (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "n" "I")
             (ALOAD_0)
             (GETFIELD . "n^1" "I")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;II)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f [^int a ^int b]
                             (let* [n (+ a b)
                                    fw1 (fn* fw1-fn ^int [] n)
                                    n (- a b)
                                    fw2 (fn* fw2-fn ^int [] (* n (fw1)))]
                               (fn* g ^int []
                                    (fw2)))))]))))

(deftest letfn-over-test
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "f~2" "(II)I")
             ["LOCAL 0: int a"]
             ["LOCAL 1: int b"]
             (ILOAD_0)
             (ILOAD_1)
             (IADD)
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "g" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~2" "(II)I"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (letfn* [(f ^int [^int a ^int b]
                             (+ a b))]
                         (def g f))]))))

(deftest nested-closure-propagation
  ;; Derived from emit-hinted-impl in core_deftype.cljt: propagates
  ;; closed over value `param` from heavyweight `nested` to flyweight
  ;; `hint-fn` to heavyweight `anon`.
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "top$hint-fn~0" "(I)Ljava/lang/Object;")
             ["LOCAL 0: int param"]
             (ILOAD_0)
             (INVOKESTATIC top$hint-fn$nested "__create"
                           "(I)Lpkg/ns0/top$hint-fn$nested;")
             (ARETURN)]

            [(METHOD [PUBLIC STATIC FINAL] "top~1" "(I)Ljava/lang/Object;")
             ["LOCAL 0: int param"]
             (ILOAD_0)
             (INVOKESTATIC top$anon "__create" "(I)Lpkg/ns0/top$anon;")
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/top$anon"
                   nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "param" "I")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()Ljava/lang/Object;")
             ["LOCAL 0: top$anon anon"]
             (ALOAD_0)
             (GETFIELD . "param" "I")
             (INVOKESTATIC _10 "top$hint-fn~0" "(I)Ljava/lang/Object;")
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: top$anon __this"]
             #_["LOCAL 1: int n"]
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: top$anon __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: int param"]
             (ALOAD_0)
             (ILOAD_2)
             (PUTFIELD . "param" "I")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(I)Lpkg/ns0/top$anon;")
             #_["LOCAL 0: int param"]
             (NEW top$anon)
             (DUP)
             (ACONST_NULL)
             (ILOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/top$anon;")
             #_["LOCAL 0: top$anon __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW top$anon)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "param" "I")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/top$hint-fn$nested" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "param" "I")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()Ljava/lang/Object;")
             ["LOCAL 0: top$hint-fn$nested nested"]
             (GETSTATIC System "out" "Ljava/io/PrintStream;")
             (ALOAD_0)
             (GETFIELD . "param" "I")
             (INVOKESTATIC Integer "toString" "(I)Ljava/lang/String;")
             (INVOKEVIRTUAL PrintStream "println" "(Ljava/lang/String;)V")
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: top$hint-fn$nested __this"]
             #_["LOCAL 1: int n"]
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: top$hint-fn$nested __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: int param"]
             (ALOAD_0)
             (ILOAD_2)
             (PUTFIELD . "param" "I")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(I)Lpkg/ns0/top$hint-fn$nested;")
             #_["LOCAL 0: int param"]
             (NEW top$hint-fn$nested)
             (DUP)
             (ACONST_NULL)
             (ILOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/top$hint-fn$nested;")
             #_["LOCAL 0: top$hint-fn$nested __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW top$hint-fn$nested)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "param" "I")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (fn* top [^int param]
                      (let* [hint (fn* hint-fn []
                                       (fn* nested []
                                            (.println System/out
                                                      (Integer/toString param))))]
                        (fn* anon []
                             (hint))))]))))

(deftest virtuals-passed-into-flyweight
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "top$g~0" "(Lpkg/ns0/top$f;)I")
             ["LOCAL 0: top$f f"]
             (ALOAD_0)
             (INVOKEVIRTUAL top$f "fn0" "()I")
             (IRETURN)]
            [(METHOD [STATIC FINAL] "top$h~1" "(Lpkg/ns0/top$f;Ljava/lang/Object;)I")
             ["LOCAL 0: top$f f"]
             ["LOCAL 1: Object x"]
             (ALOAD_0)
             (INVOKESTATIC . "top$g~0" "(Lpkg/ns0/top$f;)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "top~1" "(I)I")
             ["LOCAL 0: int param"]
             (ILOAD_0)
             (INVOKESTATIC top$f "__create" "(I)Lpkg/ns0/top$f;")
             (ASTORE_1)
             ["LOCAL 1: top$f f"]
             (ALOAD_1)
             (INVOKESTATIC Objects "requireNonNull" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (POP)
             (ALOAD_1)
             (LDC "foo")
             (INVOKESTATIC . "top$h~1" "(Lpkg/ns0/top$f;Ljava/lang/Object;)I")
             (IRETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "top" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "top~1" "(I)I"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/top$f" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "param" "I")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()I")
             ["LOCAL 0: top$f f"]
             (ALOAD_0)
             (GETFIELD . "param" "I")
             (IRETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: top$f __this"]
             #_["LOCAL 1: int n"]
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()I"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: top$f __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()I"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: int param"]
             (ALOAD_0)
             (ILOAD_2)
             (PUTFIELD . "param" "I")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(I)Lpkg/ns0/top$f;")
             #_["LOCAL 0: int param"]
             (NEW top$f)
             (DUP)
             (ACONST_NULL)
             (ILOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/top$f;")
             #_["LOCAL 0: top$f __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW top$f)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "param" "I")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def top
                   (fn* top ^int [^int param]
                        (letfn* [(f ^int []
                                    param)
                                 (g ^int []
                                    (f))
                                 (h ^int [x]
                                    (g))]
                                (java.util.Objects/requireNonNull f) ;force value
                                (h "foo"))))]))))

(deftest indirect-env-test
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL] "align$step-at~2"
                     "([[Ljava/lang/Object;II)Ljava/lang/Object;")
             ["LOCAL 0: Object[][] grid"]
             ["LOCAL 1: int i"]
             ["LOCAL 2: int j"]
             (ALOAD_0)
             (ILOAD_1)
             (AALOAD)
             (ILOAD_2)
             (AALOAD)
             (ARETURN)]
            [(METHOD [STATIC FINAL] "align$extend*~2"
                     "([[Ljava/lang/Object;II)Ljava/lang/Object;")
             ["LOCAL 0: Object[][] grid"]
             ["LOCAL 1: int i"]
             ["LOCAL 2: int j"]
             (ALOAD_0)
             (ILOAD_1)
             (ILOAD_2)
             (INVOKESTATIC . "align$step-at~2"
                           "([[Ljava/lang/Object;II)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [STATIC FINAL] "align$align-a-and-b~2"
                     "([[Ljava/lang/Object;II)Ljava/lang/Object;")
             ["LOCAL 0: Object[][] grid"]
             ["LOCAL 1: int i"]
             ["LOCAL 2: int j"]
             (ALOAD_0)
             (ILOAD_1)
             (ILOAD_2)
             (INVOKESTATIC . "align$extend*~2"
                           "([[Ljava/lang/Object;II)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "align~0" "()Ljava/lang/Object;")
             (ICONST_2)
             (ICONST_3)
             (MULTIANEWARRAY "Object[][]" 2)
             (ASTORE_0)
             ["LOCAL 0: Object[][] grid"]
             (ACONST_NULL)
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>"
                     "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (fn* align []
                      (let* [grid (new Object/2 2 3)]
                        (letfn* [(step-at [^int i ^int j]
                                          (aget (aget grid i) j))
                                 (extend* [^int i ^int j]
                                          (step-at i j))
                                 (align-a-and-b [^int i ^int j]
                                                (extend* i j))])))]))))

(deftest binding-closure-interaction-test
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "outer~1" "(I)Ljava/lang/Object;")
             ["LOCAL 0: int n"]
             (ILOAD_0)
             (INVOKESTATIC outer$f "__create" "(I)Lpkg/ns0/outer$f;")
             (ASTORE_1)
             ["LOCAL 1: outer$f f"]
             (ALOAD_1)
             (INVOKEVIRTUAL outer$f "fn0" "()V")
             (ALOAD_1)
             (INVOKEVIRTUAL outer$f "fn0" "()V")
             (ALOAD_1)
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/outer$f" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "n" "I")]
            [(METHOD [PUBLIC FINAL] "fn0" "()V")
             ["LOCAL 0: outer$f f"]
             (GETSTATIC System "out" "Ljava/io/PrintStream;")
             (ALOAD_0)
             (GETFIELD . "n" "I")
             (INVOKEVIRTUAL PrintStream "println" "(I)V")
             (RETURN)]
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull"
                     "(I)Ljava/lang/invoke/MethodHandle;")
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()V"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD
              [PUBLIC FINAL SYNTHETIC]
              "__directMethodHandles"
              "()[Ljava/lang/invoke/MethodHandle;")
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()V"])
             (AASTORE)
             (ARETURN)]
            [(METHOD [PRIVATE SYNTHETIC] "<init>"
                     "(Lclojure/lang/IPersistentMap;I)V")
             (ALOAD_0)
             (ILOAD_2)
             (PUTFIELD . "n" "I")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create"
                     "(I)Lpkg/ns0/outer$f;")
             (NEW outer$f)
             (DUP)
             (ACONST_NULL)
             (ILOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl"
                     "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/outer$f;")
             (NEW outer$f)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "n" "I")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;I)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (fn* outer [^int n]
                      ;; only one instance of `f` should be __create()-ed
                      (letfn* [(f ^void [] (.println System/out n))]
                              (f) (f) f))]))))

(deftest create-then-patch-test
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "x" "Lpkg/ns0/f;")]
            [(FIELD [PUBLIC STATIC FINAL] "y" "Lpkg/ns0/g;")]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (INVOKESTATIC System "currentTimeMillis" "()J")
             (LSTORE_0)
             ["LOCAL 0: long n"]
             (LLOAD_0)
             (ACONST_NULL)              ;updated by call to __patch below
             (INVOKESTATIC f "__create" "(JLpkg/ns0/g;)Lpkg/ns0/f;")
             (ASTORE_2)
             ["LOCAL 2: f f"]
             (LLOAD_0)
             (ALOAD_2)
             (INVOKESTATIC g "__create" "(JLpkg/ns0/f;)Lpkg/ns0/g;")
             (ASTORE_3)
             ["LOCAL 3: g g"]
             
             (ALOAD_2)                  ;load f for receiver
             (ALOAD_3)                  ;load g as argument
             (INVOKEVIRTUAL f "__patch" "(Lpkg/ns0/g;)V")
             
             (ALOAD_2)
             (PUTSTATIC . "x" "Lpkg/ns0/f;")
             (ALOAD_3)
             (PUTSTATIC . "y" "Lpkg/ns0/g;")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/f" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "n" "J")]
            [(FIELD [PRIVATE] "g" "Lpkg/ns0/g;")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()Ljava/lang/Object;")
             ["LOCAL 0: f f"]
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (POP2)
             (ALOAD_0)
             (GETFIELD . "g" "Lpkg/ns0/g;")
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (AASTORE)
             (ARETURN)]
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;JLpkg/ns0/g;)V")
             (ALOAD_0)
             (LLOAD_2)
             (PUTFIELD . "n" "J")
             (ALOAD_0)
             (ALOAD 4)
             (PUTFIELD . "g" "Lpkg/ns0/g;")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(JLpkg/ns0/g;)Lpkg/ns0/f;")
             (NEW f)
             (DUP)
             (ACONST_NULL)
             (LLOAD_0)
             (ALOAD_2)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;JLpkg/ns0/g;)V")
             (ARETURN)]
            [(METHOD [FINAL SYNTHETIC] "__patch" "(Lpkg/ns0/g;)V")
             (ALOAD_0)
             (ALOAD_1)
             (PUTFIELD . "g" "Lpkg/ns0/g;")
             (RETURN)]
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/f;")
             (NEW f)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (ALOAD_0)
             (GETFIELD . "g" "Lpkg/ns0/g;")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;JLpkg/ns0/g;)V")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/g" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "n" "J")]
            [(FIELD [PRIVATE FINAL] "f" "Lpkg/ns0/f;")]
            
            [(METHOD [PUBLIC FINAL] "fn0" "()Ljava/lang/Object;")
             ["LOCAL 0: g g"]
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (POP2)
             (ALOAD_0)
             (GETFIELD . "f" "Lpkg/ns0/f;")
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             (ILOAD_1)
             (IFNE L:0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (ARETURN)
             [L:0]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn0" "()Ljava/lang/Object;"])
             (AASTORE)
             (ARETURN)]
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;JLpkg/ns0/f;)V")
             (ALOAD_0)
             (LLOAD_2)
             (PUTFIELD . "n" "J")
             (ALOAD_0)
             (ALOAD 4)
             (PUTFIELD . "f" "Lpkg/ns0/f;")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(JLpkg/ns0/f;)Lpkg/ns0/g;")
             (NEW g)
             (DUP)
             (ACONST_NULL)
             (LLOAD_0)
             (ALOAD_2)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;JLpkg/ns0/f;)V")
             (ARETURN)]
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/g;")
             (NEW g)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (ALOAD_0)
             (GETFIELD . "f" "Lpkg/ns0/f;")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;JLpkg/ns0/f;)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (let* [n (System/currentTimeMillis)]
                   (letfn* [(f [] n g)  ;forward reference to `g`
                            (g [] n f)]
                           (def x f)
                           (def y g)))]))))
