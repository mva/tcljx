;; Copyright (c) Michael van Acken. All rights reserved.
;; The use and distribution terms for this software are covered by the
;; Eclipse Public License 2.0 (https:;;www.eclipse.org/legal/epl-v20.html)
;; which can be found in the file epl-v20.html at the root of this distribution.
;; By using this software in any fashion, you are agreeing to be bound by
;; the terms of this license.
;; You must not remove this notice, or any other, from this software.
(ns tcljx.nmspgen.variadic-test
  (:require [tcljx.nmspgen.bootstrap :refer [nmsp asm-expr]]
            [tcljx.alpha.ptest :refer :all]))

(deftest varargs-list
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL VARARGS] "fn~1"
                     "([Ljava/lang/Object;)Lclojure/lang/IPersistentList;")
             ["LOCAL 0: Object[] items"]
             (ALOAD_0)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (INVOKESTATIC PersistentList "create" "(Ljava/util/List;)Lclojure/lang/IPersistentList;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "fn~1" "([Ljava/lang/Object;)Lclojure/lang/IPersistentList;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]

           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def list
                   (fn* ^clojure.lang.IPersistentList [& ^Object/1 items]
                        (clojure.lang.PersistentList/create (java.util.Arrays/asList items))))]))))

(deftest varargs-closure-with-fixed-and-varargs
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (INVOKESTATIC System "currentTimeMillis" "()J")
             (LSTORE_0)
             ["LOCAL 0: long n"]
             (LLOAD_0)
             (INVOKESTATIC fn "__create" "(J)Lpkg/ns0/fn;")
             (POP)
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD
              [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/fn" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "n" "J")]
            
            [(METHOD [PUBLIC FINAL] "fn1" "(Ljava/lang/Object;)J")
             ["LOCAL 0: fn fn"]
             ["LOCAL 1: Object item"]
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (LRETURN)]
            [(METHOD [PUBLIC FINAL VARARGS] "fn2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)J")
             ["LOCAL 0: fn fn"]
             ["LOCAL 1: Object item"]
             ["LOCAL 2: Object[] more"]
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (LRETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull"
                     "(I)Ljava/lang/invoke/MethodHandle;")
             (ILOAD_1)
             (TABLESWITCH 0 1 L:2 [L:0 L:1])
             [L:0]
             (ACONST_NULL)
             (ARETURN)
             [L:1]
             (LDC [VIRTUAL . "fn1" "(Ljava/lang/Object;)J"])
             (ARETURN)
             [L:2]
             (LDC [VIRTUAL . "fn2" "(Ljava/lang/Object;[Ljava/lang/Object;)J"])
             (ARETURN)]
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles"
                     "()[Ljava/lang/invoke/MethodHandle;")
             (ICONST_2)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn1" "(Ljava/lang/Object;)J"])
             (AASTORE)
             (DUP)
             (ICONST_1)
             (LDC [VIRTUAL . "fn2" "(Ljava/lang/Object;[Ljava/lang/Object;)J"])
             (AASTORE)
             (ARETURN)]
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;J)V")
             (ALOAD_0)
             (LLOAD_2)
             (PUTFIELD . "n" "J")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(J)Lpkg/ns0/fn;")
             (NEW fn)
             (DUP)
             (ACONST_NULL)
             (LLOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;J)V")
             (ARETURN)]
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl"
                     "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/fn;")
             (NEW fn)
             (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "n" "J")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;J)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (let* [n (System/currentTimeMillis)]
                   (fn*
                    (^long [^Object item] n)
                    (^long [^Object item & ^Object/1 more] n)))]))))

(deftest varargs-invoke
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "l0" "Ljava/util/List;")]
            [(FIELD [PUBLIC STATIC FINAL] "l1" "Ljava/util/List;")]
            [(FIELD [PUBLIC STATIC FINAL] "l2" "Ljava/util/List;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_0)
             (ANEWARRAY "Object[]")
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "l0" "Ljava/util/List;")

             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_1)
             (INVOKESTATIC Integer "valueOf" "(I)Ljava/lang/Integer;")
             (AASTORE)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "l1" "Ljava/util/List;")
             
             (ICONST_2)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_1)
             (INVOKESTATIC Integer "valueOf" "(I)Ljava/lang/Integer;")
             (AASTORE)
             (DUP)
             (ICONST_1)
             (ICONST_2)
             (INVOKESTATIC Integer "valueOf" "(I)Ljava/lang/Integer;")
             (AASTORE)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "l2" "Ljava/util/List;")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def as-list
                   (fn* as-list ^java.util.List [& ^Object/1 items]
                        (java.util.Arrays/asList items)))
                 (def l0 (as-list))
                 (def l1 (as-list 1))
                 (def l2 (as-list 1 2))]))))

(deftest varargs-array-to-array
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL]
                    "lnested" "Ljava/util/List;")]
            [(FIELD [PUBLIC STATIC FINAL]
                    "lints" "Ljava/util/List;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL VARARGS] "as-list-wrapped~1" "([Ljava/lang/Object;)Ljava/util/List;")
             ["LOCAL 0: Object[] items"]
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ALOAD_0)
             (AASTORE)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "as-list-wrapped" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "as-list-wrapped~1"
                     "([Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_1)
             (INVOKESTATIC Integer "valueOf" "(I)Ljava/lang/Integer;")
             (AASTORE)
             (INVOKESTATIC . "as-list-wrapped~1" "([Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "lnested" "Ljava/util/List;")
             
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_0)
             (NEWARRAY "int[]")
             (AASTORE)
             (INVOKESTATIC . "as-list-wrapped~1" "([Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "lints" "Ljava/util/List;")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def as-list
                   (fn* as-list ^java.util.List [& ^Object/1 items]
                        ;; method call passes array `items` unmodified to
                        ;; `asList` (the "varargs agnostic" calling
                        ;; convention)
                        (java.util.Arrays/asList items)))
                 (def as-list-wrapped
                   (fn* as-list-wrapped ^java.util.List [& ^Object/1 items]
                        ;; function call wraps array `items` in another
                        ;; array before calling `as-list` (i.e. an
                        ;; `(Object)items` is passed on)
                        (as-list items)))
                 (def lnested (as-list-wrapped 1))
                 (def lints (as-list-wrapped (new int/1 0)))])))
  ;; At the moment, ints cannot be passed to an objects vararg
  ;; directly.  As such there is no need to cast them to object if
  ;; they appear in a vararg argument position.  This will probably
  ;; change with Valhalla.  (Also applies to call to varargs method.)
  (is (not (.isAssignableFrom Object/1 int/1))))

(deftest varargs-applyfn-invoke
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "l0" "Ljava/lang/Object;")]
            [(FIELD [PUBLIC STATIC FINAL] "l1" "Ljava/lang/Object;")]
            [(FIELD [PUBLIC STATIC FINAL] "l2" "Ljava/lang/Object;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "apply-0~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;)Ljava/lang/Object;"
                            :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-0" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-0~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "apply-1~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (ICONST_1)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;I)Ljava/lang/Object;"
                            :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-1" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-1~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "apply-2~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (ICONST_1)
             (ICONST_2)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;II)Ljava/lang/Object;"
                            :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-2" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-2~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (INVOKESTATIC . "as-list" "()Ltinyclj/lang/StaticFn;")
             (INVOKESTATIC . "apply-0~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "l0" "Ljava/lang/Object;")

             (INVOKESTATIC . "as-list" "()Ltinyclj/lang/StaticFn;")
             (INVOKESTATIC . "apply-1~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "l1" "Ljava/lang/Object;")

             (INVOKESTATIC . "as-list" "()Ltinyclj/lang/StaticFn;")
             (INVOKESTATIC . "apply-2~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "l2" "Ljava/lang/Object;")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def as-list
                   (fn* as-list ^java.util.List [& ^Object/1 items]
                        (java.util.Arrays/asList items)))
                 (def apply-0 (fn* apply-0 [f] (f)))
                 (def apply-1 (fn* apply-1 [f] (f 1)))
                 (def apply-2 (fn* apply-2 [f] (f 1 2)))
                 (def l0 (apply-0 as-list))
                 (def l1 (apply-1 as-list))
                 (def l2 (apply-2 as-list))]))))

(deftest varargs-applyfn-invoke-closure
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "as-list-fn" "Ltinyclj/lang/AFnMh;")]
            [(FIELD [PUBLIC STATIC FINAL] "l0" "Ljava/lang/Object;")]
            [(FIELD [PUBLIC STATIC FINAL] "l1" "Ljava/lang/Object;")]
            [(FIELD [PUBLIC STATIC FINAL] "l2" "Ljava/lang/Object;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "fn~1" "(Ljava/lang/String;)Ltinyclj/lang/AFnMh;")
             ["LOCAL 0: String s"]
             (ALOAD_0)
             (INVOKESTATIC fn$as-list "__create" "(Ljava/lang/String;)Lpkg/ns0/fn$as-list;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "mk-as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "fn~1"
                     "(Ljava/lang/String;)Ltinyclj/lang/AFnMh;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "apply-0~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;)Ljava/lang/Object;" :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-0" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-0~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "apply-1~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (ICONST_1)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;I)Ljava/lang/Object;" :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-1" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-1~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "apply-2~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (ICONST_1)
             (ICONST_2)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;II)Ljava/lang/Object;" :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-2" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-2~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (LDC "")
             (INVOKESTATIC . "fn~1" "(Ljava/lang/String;)Ltinyclj/lang/AFnMh;")
             (PUTSTATIC . "as-list-fn" "Ltinyclj/lang/AFnMh;")
             
             (GETSTATIC . "as-list-fn" "Ltinyclj/lang/AFnMh;")
             (INVOKESTATIC . "apply-0~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "l0" "Ljava/lang/Object;")

             (GETSTATIC . "as-list-fn" "Ltinyclj/lang/AFnMh;")
             (INVOKESTATIC . "apply-1~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "l1" "Ljava/lang/Object;")
            
             (GETSTATIC . "as-list-fn" "Ltinyclj/lang/AFnMh;")
             (INVOKESTATIC . "apply-2~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "l2" "Ljava/lang/Object;")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/fn$as-list" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "s" "Ljava/lang/String;")]
            
            [(METHOD [PUBLIC FINAL VARARGS] "fn1" "([Ljava/lang/Object;)Ljava/util/List;")
             ["LOCAL 0: fn$as-list as-list"]
             ["LOCAL 1: Object[] items"]
             (GETSTATIC System "out" "Ljava/io/PrintStream;")
             (ALOAD_0)
             (GETFIELD . "s" "Ljava/lang/String;")
             (INVOKEVIRTUAL PrintStream "print" "(Ljava/lang/String;)V")
             (ALOAD_1)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: fn$as-list __this"]
             #_["LOCAL 1: int n"]
             (LDC [VIRTUAL . "fn1" "([Ljava/lang/Object;)Ljava/util/List;"])
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: fn$as-list __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn1" "([Ljava/lang/Object;)Ljava/util/List;"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/String;)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: String s"]
             (ALOAD_0)
             (ALOAD_2)
             (PUTFIELD . "s" "Ljava/lang/String;")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(Ljava/lang/String;)Lpkg/ns0/fn$as-list;")
             #_["LOCAL 0: String s"]
             (NEW fn$as-list) (DUP)
             (ACONST_NULL)
             (ALOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/String;)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/fn$as-list;")
             #_["LOCAL 0: fn$as-list __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW fn$as-list) (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "s" "Ljava/lang/String;")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/String;)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def mk-as-list
                   (fn* ^__auto-return-type__ [^String s]
                        (fn* as-list ^java.util.List [& ^Object/1 items]
                             (.print System/out s)
                             (java.util.Arrays/asList items))))
                 (def apply-0 (fn* apply-0 [f] (f)))
                 (def apply-1 (fn* apply-1 [f] (f 1)))
                 (def apply-2 (fn* apply-2 [f] (f 1 2)))
                 (def as-list-fn (mk-as-list ""))
                 (def l0 (apply-0 as-list-fn))
                 (def l1 (apply-1 as-list-fn))
                 (def l2 (apply-2 as-list-fn))]))))

(deftest varargs-applyfn-array-to-array
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "l1" "Ljava/util/List;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL VARARGS] "apply-1~2" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/util/List;")
             ["LOCAL 0: Object f"]
             ["LOCAL 1: Object[] items"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;Ljava/lang/Object;)Ljava/util/List;"
                            :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-1" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-1~2" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (INVOKESTATIC . "as-list" "()Ltinyclj/lang/StaticFn;")
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_1)
             (INVOKESTATIC Integer "valueOf" "(I)Ljava/lang/Integer;")
             (AASTORE)
             (INVOKESTATIC . "apply-1~2" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "l1" "Ljava/util/List;")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def as-list
                   (fn* as-list ^java.util.List [& ^Object/1 items]
                        ;; method call passes array `items` unmodified to
                        ;; `asList` (the "varargs agnostic" calling
                        ;; convention)
                        (java.util.Arrays/asList items)))
                 (def apply-1
                   (fn* apply-1 ^java.util.List [f & ^Object/1 items]
                        ;; function call wraps array `items` in another
                        ;; array before calling `as-list` (i.e. an
                        ;; `(Object)items` is passed on)
                        ^java.util.List (f items))) ;cast pushes type into INVOKEDYNAMIC
                 (def l1 (apply-1 as-list 1))]))))

(deftest varargs-applyfn-array-to-array-closure
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "l1" "Ljava/util/List;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "fn~1" "(Ljava/lang/String;)Ltinyclj/lang/AFnMh;")
             ["LOCAL 0: String s"]
             (ALOAD_0)
             (INVOKESTATIC fn$as-list "__create"
                           "(Ljava/lang/String;)Lpkg/ns0/fn$as-list;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "mk-as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "fn~1" "(Ljava/lang/String;)Ltinyclj/lang/AFnMh;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL VARARGS] "apply-1~2" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/util/List;")
             ["LOCAL 0: Object f"]
             ["LOCAL 1: Object[] items"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;Ljava/lang/Object;)Ljava/util/List;"
                            :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "apply-1" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "apply-1~2" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
                        
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (LDC "")
             (INVOKESTATIC . "fn~1" "(Ljava/lang/String;)Ltinyclj/lang/AFnMh;")
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_1)
             (INVOKESTATIC Integer "valueOf" "(I)Ljava/lang/Integer;")
             (AASTORE)
             (INVOKESTATIC . "apply-1~2" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "l1" "Ljava/util/List;")
             
             (RETURN)]]
           
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/fn$as-list" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "s" "Ljava/lang/String;")]
            
            [(METHOD [PUBLIC FINAL VARARGS] "fn1" "([Ljava/lang/Object;)Ljava/util/List;")
             ["LOCAL 0: fn$as-list as-list"]
             ["LOCAL 1: Object[] items"]
             (GETSTATIC System "out" "Ljava/io/PrintStream;")
             (ALOAD_0)
             (GETFIELD . "s" "Ljava/lang/String;")
             (INVOKEVIRTUAL PrintStream "print" "(Ljava/lang/String;)V")
             (ALOAD_1)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: fn$as-list __this"]
             #_["LOCAL 1: int n"]
             (LDC [VIRTUAL . "fn1" "([Ljava/lang/Object;)Ljava/util/List;"])
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: fn$as-list __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn1" "([Ljava/lang/Object;)Ljava/util/List;"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/String;)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: String s"]
             (ALOAD_0)
             (ALOAD_2)
             (PUTFIELD . "s" "Ljava/lang/String;")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(Ljava/lang/String;)Lpkg/ns0/fn$as-list;")
             #_["LOCAL 0: String s"]
             (NEW fn$as-list) (DUP)
             (ACONST_NULL)
             (ALOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/String;)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/fn$as-list;")
             #_["LOCAL 0: fn$as-list __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW fn$as-list) (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "s" "Ljava/lang/String;")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/String;)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def mk-as-list
                   (fn* ^__auto-return-type__ [^String s]
                        (fn* as-list ^java.util.List [& ^Object/1 items]
                             (.print System/out s)
                             ;; method call passes array `items` unmodified to
                             ;; `asList` (the "varargs agnostic" calling
                             ;; convention)
                             (java.util.Arrays/asList items))))
                 (def apply-1
                   (fn* apply-1 ^java.util.List [f & ^Object/1 items]
                        ;; function call wraps array `items` in another
                        ;; array before calling `as-list` (i.e. an
                        ;; `(Object)items` is passed on)
                        (f items)))
                 (def l1 (apply-1 (mk-as-list "") 1))]))))

(deftest variadic-array-to-iseq
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "callee-gets-iseq~1"
                     "([Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: Object[] items"]
             (ALOAD_0)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "callee-gets-iseq~1"
                           "(Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq~1"
                     "(Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: ISeq items"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq"
                     "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "callee-gets-iseq~1"
                     "([Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def callee-gets-iseq
                   (fn* callee-gets-iseq [& items]
                        ))]))))

(deftest variadic-array-to-iseq-apply
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "callee-gets-iseq~2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: Object item"]
             #_["LOCAL 1: Object[] items"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "callee-gets-iseq~2"
                           "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq~2"
                     "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: Object item"]
             ["LOCAL 1: ISeq items"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq"
                     "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "callee-gets-iseq~2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def callee-gets-iseq
                   (fn* callee-gets-iseq [item & items]
                        ))]))))

(deftest variadic-array-to-iseq-apply-2
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object item"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "callee-gets-iseq~2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: Object item"]
             #_["LOCAL 1: Object[] items"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "callee-gets-iseq~2"
                           "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq~2"
                     "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: Object item"]
             ["LOCAL 1: ISeq items"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "callee-gets-iseq"
                     "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "callee-gets-iseq~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;"]
                    [STATIC . "callee-gets-iseq~2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def callee-gets-iseq
                   (fn* callee-gets-iseq
                        ([item]
                         nil)
                        ([item & items]
                         nil)))]))))

(deftest variadic-array-to-iseq-apply-3
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            
            [(METHOD [PUBLIC STATIC FINAL] "and~0" "()Ljava/lang/Object;")
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "and~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "and~2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: Object x"]
             #_["LOCAL 1: Object[] next"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "and~2"
                           "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "and~2"
                     "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             ["LOCAL 1: ISeq next"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "and" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "and~0"
                     "()Ljava/lang/Object;"]
                    [STATIC . "and~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;"]
                    [STATIC . "and~2"
                     "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def and
                   (fn* and
                        ([]
                         nil)
                        ([x]
                         nil)
                        ([x & next]
                         nil)))]))))

(deftest variadic-array-to-iseq-flyweight
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [STATIC FINAL BRIDGE VARARGS SYNTHETIC] "f$callee-gets-iseq~1" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: Object x"]
             #_["LOCAL 1: Object[] items"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "f$callee-gets-iseq~1"
                           "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [STATIC FINAL] "f$callee-gets-iseq~1" "(Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             ["LOCAL 1: ISeq items"]
             (ALOAD_0)
             (ARETURN)]

            [(METHOD [PUBLIC STATIC FINAL] "f~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             (ALOAD_0)
             (ICONST_0)
             (ANEWARRAY "Object[]")
             (INVOKESTATIC . "f$callee-gets-iseq~1" "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "f~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* f [x]
                             ((fn* callee-gets-iseq [& items] x))))]))))

(deftest variadic-array-to-iseq-closure
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "fn~1" "(Ljava/lang/Object;)Ltinyclj/lang/AFnMh;")
             ["LOCAL 0: Object a"]
             (ALOAD_0)
             (INVOKESTATIC fn$callee-gets-iseq "__create"
                           "(Ljava/lang/Object;)Lpkg/ns0/fn$callee-gets-iseq;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "f" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "fn~1" "(Ljava/lang/Object;)Ltinyclj/lang/AFnMh;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC FINAL] "pkg/ns0/fn$callee-gets-iseq" nil "tinyclj/lang/AFnMh")
            [(FIELD [PRIVATE FINAL] "a" "Ljava/lang/Object;")]
            
            [(METHOD [PUBLIC FINAL BRIDGE VARARGS SYNTHETIC] "fn1"
                     "([Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: fn$callee-gets-iseq callee-gets-iseq"]
             #_["LOCAL 1: Object[] items"]
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKEVIRTUAL . "fn1" "(Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL] "fn1"
                     "(Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: fn$callee-gets-iseq callee-gets-iseq"]
             ["LOCAL 1: ISeq items"]
             (ALOAD_0)
             (GETFIELD . "a" "Ljava/lang/Object;")
             (ARETURN)]

            [(METHOD [PUBLIC FINAL SYNTHETIC] "__arityOrNull" "(I)Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: fn$callee-gets-iseq __this"]
             #_["LOCAL 1: int n"]
             (LDC [VIRTUAL . "fn1" "([Ljava/lang/Object;)Ljava/lang/Object;"])
             (ARETURN)]
            
            [(METHOD [PUBLIC FINAL SYNTHETIC] "__directMethodHandles" "()[Ljava/lang/invoke/MethodHandle;")
             #_["LOCAL 0: fn$callee-gets-iseq __this"]
             (ICONST_1)
             (ANEWARRAY "MethodHandle[]")
             (DUP)
             (ICONST_0)
             (LDC [VIRTUAL . "fn1" "([Ljava/lang/Object;)Ljava/lang/Object;"])
             (AASTORE)
             (ARETURN)]
            
            [(METHOD [PRIVATE SYNTHETIC] "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/Object;)V")
             #_["LOCAL 0: uninitialized_this_type __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             #_["LOCAL 2: Object a"]
             (ALOAD_0)
             (ALOAD_2)
             (PUTFIELD . "a" "Ljava/lang/Object;")
             (ALOAD_0)
             (ALOAD_1)
             (INVOKESPECIAL AFnMh "<init>" "(Lclojure/lang/IPersistentMap;)V")
             (RETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "__create" "(Ljava/lang/Object;)Lpkg/ns0/fn$callee-gets-iseq;")
             #_["LOCAL 0: Object a"]
             (NEW fn$callee-gets-iseq) (DUP)
             (ACONST_NULL)
             (ALOAD_0)
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/Object;)V")
             (ARETURN)]
            
            [(METHOD [PROTECTED FINAL SYNTHETIC] "__withMetaImpl" "(Lclojure/lang/IPersistentMap;)Lpkg/ns0/fn$callee-gets-iseq;")
             #_["LOCAL 0: fn$callee-gets-iseq __this"]
             #_["LOCAL 1: IPersistentMap __meta"]
             (NEW fn$callee-gets-iseq) (DUP)
             (ALOAD_1)
             (ALOAD_0)
             (GETFIELD . "a" "Ljava/lang/Object;")
             (INVOKESPECIAL . "<init>" "(Lclojure/lang/IPersistentMap;Ljava/lang/Object;)V")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def f (fn* ^__auto-return-type__ [a]
                             (fn* callee-gets-iseq [& items]
                                  a)))]))))

(deftest non-matching-array-to-rest-parameter
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "x" "Ljava/lang/Object;")]
            
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "concat~3"
                     "(Ljava/lang/Object;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             #_["LOCAL 0: Object x"]
             #_["LOCAL 1: Object y"]
             #_["LOCAL 2: Object[] zs"]
             (ALOAD_0)
             (ALOAD_1)
             (ALOAD_2)
             (INVOKESTATIC ArraySeq "create" "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "concat~3" "(Ljava/lang/Object;Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "concat~3"
                     "(Ljava/lang/Object;Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             ["LOCAL 1: Object y"]
             ["LOCAL 2: ISeq zs"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "concat" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "concat~3" "(Ljava/lang/Object;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_0)
             (ANEWARRAY "Object[]")
             (ICONST_0)
             (ANEWARRAY "Object[]")
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ICONST_0)
             (ANEWARRAY "Integer[]")
             (AASTORE)
             (INVOKESTATIC . "concat~3" "(Ljava/lang/Object;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             (PUTSTATIC . "x" "Ljava/lang/Object;")

             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def concat (fn* concat [x y & zs]
                                  nil))
                 (def x (concat (new Object/1 0)
                                (new Object/1 0)
                                (new Integer/1 0)))]))))

(deftest object-to-varargs-parameter
  (is (= '[["LOCAL 0: Object fname"]
           (LDC "resources")
           (ICONST_1)
           (ANEWARRAY "String[]")
           (DUP)
           (ICONST_0)
           (ALOAD_0)
           (CHECKCAST String)
           (AASTORE)
           (INVOKESTATIC Path "of"
                         "(Ljava/lang/String;[Ljava/lang/String;)Ljava/nio/file/Path;"
                         :itf)
           (ARETURN)]
         (asm-expr [fname]
                   (java.nio.file.Path/of "resources" fname)))))

(deftest object-to-variadic-parameter
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/exp/_10")
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "println~1"
                     "([Ljava/lang/Object;)Ljava/lang/Object;")
             (ALOAD_0)
             (INVOKESTATIC ArraySeq "create"
                           "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "println~1" "(Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "println~1"
                     "(Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: ISeq more"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "println" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "println~1"
                     "([Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "fn~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ALOAD_0)
             (AASTORE)
             (INVOKESTATIC . "println~1"
                           "([Ljava/lang/Object;)Ljava/lang/Object;")
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.exp")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/exp/___" nil "pkg/exp/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]
           
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "fn~1"
                     "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object x"]
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (ALOAD_0)
             (AASTORE)
             (INVOKESTATIC _10 "println~1" "([Ljava/lang/Object;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (LDC ___)
             (INVOKESTATIC RT "ensureInitialized" "(Ljava/lang/Class;)V")
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core,pkg.exp")
             (ARETURN)]]]
         (nmsp '[(ns pkg.exp)
                 (def println (fn* println [& more] nil))
                 (fn* [x] (println x))  ;call local fn def
                 (ns pkg.ns0 (:require pkg.exp))
                 (fn* [x] (pkg.exp/println x))])))) ;call imported fn def

(deftest void-as-vararg
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL] "x" "Ljava/util/List;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "void-fn~1" "(Ljava/lang/String;)V")
             ["LOCAL 0: String s"]
             (RETURN)]
            [(METHOD [PUBLIC STATIC FINAL]
                     "void-fn" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "void-fn~1" "(Ljava/lang/String;)V"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "as-list" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC FINAL] "fn~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object f"]
             (ALOAD_0)
             (LDC "foo")
             (INVOKESTATIC . "void-fn~1" "(Ljava/lang/String;)V")
             (ACONST_NULL)
             (INVOKEDYNAMIC "_" "(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;" :bsm-invoke-fn [])
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "y" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "fn~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]

            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             
             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (LDC "foo")
             (INVOKESTATIC . "void-fn~1" "(Ljava/lang/String;)V")
             (ACONST_NULL)
             (AASTORE)
             (INVOKESTATIC Arrays "asList" "([Ljava/lang/Object;)Ljava/util/List;")
             (PUTSTATIC . "x" "Ljava/util/List;")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def void-fn (fn* void-fn ^void [^String s]))
                 (def as-list
                   (fn* as-list ^java.util.List [& ^Object/1 items]
                        (java.util.Arrays/asList items)))
                 (def x (as-list (void-fn "foo")))
                 (def y (fn* [f] (f (void-fn "foo"))))]))))

(deftest void-in-collection-literal
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(FIELD [PUBLIC STATIC FINAL]
                    "x" "Lclojure/lang/IPersistentVector;")]
            
            [(METHOD [PUBLIC STATIC FINAL] "void-fn~1" "(Ljava/lang/String;)V")
             ["LOCAL 0: String s"]
             (RETURN)]
            [(METHOD [PUBLIC STATIC FINAL]
                     "void-fn" "()Ltinyclj/lang/StaticFn;")
             (LDC [:bsm-static-fn "_" "Ltinyclj/lang/StaticFn;"
                   [[STATIC . "void-fn~1" "(Ljava/lang/String;)V"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")

             (ICONST_1)
             (ANEWARRAY "Object[]")
             (DUP)
             (ICONST_0)
             (LDC "foo")
             (INVOKESTATIC . "void-fn~1" "(Ljava/lang/String;)V")
             (ACONST_NULL)
             (AASTORE)
             (INVOKESTATIC Literal "vector"
                           "([Ljava/lang/Object;)Lclojure/lang/IPersistentVector;")
             (PUTSTATIC . "x" "Lclojure/lang/IPersistentVector;")
             
             (RETURN)]]
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def void-fn (fn* void-fn ^void [^String s]))
                 (def x [(void-fn "foo")])]))))

(deftest varargs-static-vs-virtual
  (is (= '[(LDC "%3.1f %3.1f")
           (ICONST_2)
           (ANEWARRAY "Object[]")
           (DUP)
           (ICONST_0)
           (DCONST_1)
           (INVOKESTATIC Double "valueOf" "(D)Ljava/lang/Double;")
           (AASTORE)
           (DUP)
           (ICONST_1)
           (LDC2_W 2.0)
           (INVOKESTATIC Double "valueOf" "(D)Ljava/lang/Double;")
           (AASTORE)
           (INVOKESTATIC String "format"
                         "(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;")
           (ARETURN)]
         (asm-expr (String/format "%3.1f %3.1f" 1.0 2.0))))
  (is (= '[(LDC "%3.1f %3.1f")
           (ICONST_2)
           (ANEWARRAY "Object[]")
           (DUP)
           (ICONST_0)
           (DCONST_1)
           (INVOKESTATIC Double "valueOf" "(D)Ljava/lang/Double;")
           (AASTORE)
           (DUP)
           (ICONST_1)
           (LDC2_W 2.0)
           (INVOKESTATIC Double "valueOf" "(D)Ljava/lang/Double;")
           (AASTORE)
           (INVOKEVIRTUAL String "formatted"
                          "([Ljava/lang/Object;)Ljava/lang/String;")
           (ARETURN)]
      (asm-expr (.formatted "%3.1f %3.1f" (object 1.0) (object 2.0))))))

(deftest varargs-ints-of-virtual
  (is (= '[(NEW Calendar$Builder)
           (DUP)
           (INVOKESPECIAL Calendar$Builder "<init>" "()V")
           (ICONST_0)
           (NEWARRAY "int[]")
           (INVOKEVIRTUAL Calendar$Builder "setFields"
                          "([I)Ljava/util/Calendar$Builder;")
           (ARETURN)]
         (asm-expr (.setFields
                    (java.util.Calendar$Builder.)
                    (new int/1 0))))))

(deftest conj-with-five-arguments-test
  (is (= '[[(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/_10")
            [(METHOD [PUBLIC STATIC FINAL] "conj~0" "()Ljava/lang/Object;")
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "conj~1" "(Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object coll"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "conj~2" "(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;")
             ["LOCAL 0: Object coll"]
             ["LOCAL 1: Object x"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL BRIDGE VARARGS SYNTHETIC] "conj~3" "(Ljava/lang/Object;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             (ALOAD_0)
             (ALOAD_1)
             (ALOAD_2)
             (INVOKESTATIC ArraySeq "create" "([Ljava/lang/Object;)Lclojure/lang/ArraySeq;")
             (INVOKESTATIC . "conj~3" "(Ljava/lang/Object;Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "conj~3" "(Ljava/lang/Object;Ljava/lang/Object;Lclojure/lang/ISeq;)Ljava/lang/Object;")
             ["LOCAL 0: Object coll"]
             ["LOCAL 1: Object x"]
             ["LOCAL 2: ISeq xs"]
             (ACONST_NULL)
             (ARETURN)]
            [(METHOD [PUBLIC STATIC FINAL] "conj" "()Ltinyclj/lang/StaticFn;")
             (LDC
              [:bsm-static-fn
               "_"
               "Ltinyclj/lang/StaticFn;"
               [[STATIC . "conj~0" "()Ljava/lang/Object;"]
                [STATIC . "conj~1" "(Ljava/lang/Object;)Ljava/lang/Object;"]
                [STATIC . "conj~2" "(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;"]
                [STATIC . "conj~3" "(Ljava/lang/Object;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;"]]])
             (ARETURN)]
            
            [(METHOD [PUBLIC STATIC] "<clinit>" "()V")
             (LDC "pkg.ns0")
             (INVOKESTATIC RT "createNamespace" "(Ljava/lang/String;)V")
             (ACONST_NULL) (LDC "a") (ICONST_3)
             (ANEWARRAY "Object[]")
             (DUP) (ICONST_0) (LDC "b") (AASTORE)
             (DUP) (ICONST_1) (LDC "c") (AASTORE)
             (DUP) (ICONST_2) (LDC "d") (AASTORE)
             (INVOKESTATIC . "conj~3" "(Ljava/lang/Object;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;")
             (POP)
             (RETURN)]]
           
           [(CLASS Vx [PUBLIC ABSTRACT] "pkg/ns0/___" nil "pkg/ns0/_10")
            [(METHOD
              [PUBLIC STATIC FINAL SYNTHETIC] "requires~1" "()Ljava/lang/String;")
             (LDC "clojure.core")
             (ARETURN)]]]
         (nmsp '[(ns pkg.ns0)
                 (def conj
                   (fn* conj
                        ([] nil)
                        ([coll] nil)
                        ([coll x] nil)
                        ([coll x & xs] nil)))
                 (conj nil "a" "b" "c" "d")]))))
